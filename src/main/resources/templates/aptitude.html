<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>MedApp - Fise Aptitudini</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>body { padding-top: 60px; }</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">MedApp</a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/companies.html">Companii</a></li>
        <li class="nav-item"><a class="nav-link" href="/employees.html">AngajaÈ›i</a></li>
        <li class="nav-item"><a class="nav-link active" href="/aptitude.html">Fise Aptitudini</a></li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item" sec:authorize="isAuthenticated()">
          <span class="nav-link text-white" th:text="'Salut, ' + ${#authentication.name}"></span>
        </li>
        <li class="nav-item" sec:authorize="isAnonymous()">
          <a class="btn btn-outline-light ms-2" href="/login.html">Login</a>
        </li>
        <li class="nav-item" sec:authorize="isAuthenticated()">
          <form th:action="@{/perform_logout}" method="post" class="d-inline">
            <button type="submit" class="btn btn-outline-light ms-2">Logout</button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
    <h2 class="mb-4 text-danger">Fise Aptitudini Medicale</h2>

    <!-- Formular Creare Fisa -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">CreeazÄƒ Fisa NouÄƒ</div>
        <div class="card-body">
            <form id="createSheetForm" class="row g-3">
                <div class="col-md-6">
                    <label for="employeeSelect" class="form-label">Angajat</label>
                    <select id="employeeSelect" class="form-select" required>
                        <option selected disabled value="">Alege Angajatul...</option>
                        <!-- Va fi populat via JS -->
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="examDate" class="form-label">Data Examinarii</label>
                    <input type="date" class="form-control" id="examDate" required>
                </div>
                <div class="col-md-6">
                    <label for="nextExamDate" class="form-label">Urmatoarea Examinare (Optional)</label>
                    <input type="date" class="form-control" id="nextExamDate">
                </div>
                <div class="col-md-6">
                    <label for="conclusion" class="form-label">Concluzia Medicala</label>
                    <select id="conclusion" class="form-select" required>
                        <option value="APT">APT</option>
                        <option value="APT CONDITIONAT">APT CONDITIONAT</option>
                        <option value="INAPT TEMPORAR">INAPT TEMPORAR</option>
                        <option value="INAPT PERMANENT">INAPT PERMANENT</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="observations" class="form-label">Observatii</label>
                    <textarea class="form-control" id="observations" rows="2"></textarea>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-danger">SalveazÄƒ Fisa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista Fise -->
    <div class="card">
        <div class="card-header">Fise Emitere</div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Angajat</th>
                        <th>Data Examen</th>
                        <th>Concluzie</th>
                        <th>Actiuni</th>
                    </tr>
                </thead>
                <tbody id="sheetsTableBody">
                    <!-- Datele vor fi populate aici via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_SHEETS = '/api/aptitude-sheets';
    const API_EMPLOYEES = '/api/employees';

    // Populate employees dropdown
    async function loadEmployees() {
        try {
            const response = await fetch(API_EMPLOYEES);
            if (response.status === 401) { // Unauthorized
                window.location.href = '/login.html';
                return;
            }
            const employees = await response.json();
            const select = document.getElementById('employeeSelect');
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.firstname} ${emp.lastname} (${emp.cnp})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }

    // Fetch and display sheets
    async function fetchSheets() {
        try {
            const response = await fetch(API_SHEETS);
            if (response.status === 401) { // Unauthorized
                window.location.href = '/login.html';
                return;
            }
            const sheets = await response.json();
            const tableBody = document.getElementById('sheetsTableBody');
            tableBody.innerHTML = '';

            sheets.forEach(sheet => {
                const empName = sheet.employee ? `<strong>${sheet.employee.firstname} ${sheet.employee.lastname}</strong>` : 'Angajat È˜ters';
                
                const row = `
                    <tr>
                        <td>${sheet.id}</td>
                        <td>${empName}</td>
                        <td>${sheet.examDate}</td>
                        <td><span class="badge bg-${getBadgeColor(sheet.medicalConclusion)}">${sheet.medicalConclusion}</span></td>
                        <td>
                            <a href="/api/aptitude-sheets/${sheet.id}/pdf" target="_blank" class="btn btn-sm btn-outline-danger">
                                ðŸ“¥ DescarcÄƒ PDF
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error('Error fetching sheets:', error);
        }
    }

    function getBadgeColor(conclusion) {
        if(conclusion.includes('APT')) return 'success';
        if(conclusion.includes('CONDITIONAT')) return 'warning';
        return 'danger';
    }

    // Create new sheet
    document.getElementById('createSheetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const employeeId = document.getElementById('employeeSelect').value;
        const sheetData = {
            employee: { id: employeeId },
            examDate: document.getElementById('examDate').value,
            nextExamDate: document.getElementById('nextExamDate').value || null,
            medicalConclusion: document.getElementById('conclusion').value,
            observations: document.getElementById('observations').value
        };

        try {
            const response = await fetch(API_SHEETS, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sheetData)
            });

            if (response.ok) {
                alert('Fisa creatÄƒ cu succes!');
                document.getElementById('createSheetForm').reset();
                fetchSheets();
            } else if (response.status === 401) { // Unauthorized
                window.location.href = '/login.html';
            } else if (response.status === 403) { // Forbidden
                alert('Nu aveÈ›i permisiunea de a crea fiÈ™e de aptitudini.');
            } else {
                alert('Eroare la crearea fisei.');
            }
        } catch (error) {
            console.error('Error creating sheet:', error);
        }
    });

    // Initial load
    loadEmployees();
    fetchSheets();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
